<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Show - JKT48 Show Theater</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* CSS Tetap untuk Mobile */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f5f5;color:#333;min-height:100vh;padding-bottom:60px;transition:background 0.3s,color 0.3s}
body.dark{background:#0a0e1a;color:#e5e7eb}

/* Header */
.main-header{position:fixed;top:0;left:0;right:0;background:#fff;z-index:1001;border-bottom:1px solid #ddd;transition:background 0.3s,border-color 0.3s}
body.dark .main-header{background:#111827;border-color:#1f2937}
.theater-header{text-align:center;padding:10px 20px;font-size:14px;font-weight:bold;color:#333;letter-spacing:1px}
body.dark .theater-header{color:#e5e7eb}
.detail-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#fff;border-top:1px solid #eee;border-bottom:1px solid #ddd;transition:background 0.3s,border-color 0.3s}
body.dark .detail-header{background:#111827;border-color:#1f2937}
.back-btn{background:transparent;border:none;color:#333;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;padding:8px 0;transition:all 0.3s}
body.dark .back-btn{color:#e5e7eb}
.back-btn:hover{opacity:0.7}
.detail-title{font-size:16px;font-weight:bold;color:#333;text-align:center;flex:1;margin:0 10px}
body.dark .detail-title{color:#e5e7eb}
.header-controls{display:flex;align-items:center;gap:10px}
.theme-toggle-detail{background:#e60012;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:8px;transition:all 0.3s}
.theme-toggle-detail:hover{background:#d5000f;transform:scale(1.1)}
.theme-toggle-detail svg{width:100%;height:100%;color:#fff}

/* Container */
.container{max-width:800px;width:100%;margin:140px auto 30px;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:background 0.3s,box-shadow 0.3s}
body.dark .container{background:#111827;box-shadow:0 2px 8px rgba(0,0,0,0.4)}

/* Show Status Header */
.live-show-header{background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);padding:25px;text-align:center;position:relative;overflow:hidden}
.live-show-header.upcoming{background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)}
.live-show-header.prelive{background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)}
.live-show-header.finished{background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%)}

/* Status Badges */
.status-badge-main{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.2);padding:6px 12px;border-radius:15px;font-size:12px;font-weight:bold;margin-bottom:10px;color:#fff}
.live-dot-main{width:8px;height:8px;background:#fff;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.upcoming-dot-main{width:8px;height:8px;background:#fff;border-radius:50%}
.prelive-dot-main{width:8px;height:8px;background:#3b82f6;border-radius:50%}

/* Birthday Badge in Header */
.birthday-badge-header {
    background: rgba(255,255,255,0.2);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    margin-top: 8px;
    color: #fff;
    animation: birthday-glow-header 2s ease-in-out infinite;
}

.birthday-badge-header svg {
    width: 12px;
    height: 12px;
    fill: currentColor;
}

@keyframes birthday-glow-header {
    0%, 100% { box-shadow: 0 0 8px rgba(255,255,255,0.3); }
    50% { box-shadow: 0 0 12px rgba(255,255,255,0.5); }
}

/* Live Show Title */
.live-show-header h1{font-size:20px;font-weight:bold;color:#fff;margin:0 0 12px 0;line-height:1.3;padding:0 10px}
.live-show-date-time{display:flex;align-items:center;justify-content:center;gap:20px;color:rgba(255,255,255,0.9);font-size:13px;flex-wrap:wrap}
.live-show-date-time div{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:center}
.live-show-date-time svg{width:16px;height:16px;flex-shrink:0}

/* Countdown Timer */
.countdown-container{
    background:rgba(255,255,255,0.15);
    border-radius:10px;
    padding:12px 16px;
    margin:12px auto;
    max-width:350px;
}
.countdown-title{
    font-size:12px;
    color:rgba(255,255,255,0.9);
    margin-bottom:8px;
    font-weight:600;
}
.countdown-timer{
    display:flex;
    justify-content:center;
    gap:12px;
}
.countdown-item{
    display:flex;
    flex-direction:column;
    align-items:center;
}
.countdown-value{
    font-size:24px;
    font-weight:bold;
    color:#fff;
    background:rgba(0,0,0,0.2);
    padding:6px 10px;
    border-radius:6px;
    min-width:45px;
    text-align:center;
}
.countdown-label{
    font-size:10px;
    color:rgba(255,255,255,0.8);
    margin-top:4px;
    text-transform:uppercase;
    font-weight:600;
}

/* Live Watch Button */
.watch-live-btn{
    background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color:#fff;
    border:none;
    padding:14px 28px;
    border-radius:10px;
    font-size:14px;
    font-weight:bold;
    cursor:pointer;
    margin:16px auto;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    box-shadow:0 4px 12px rgba(239,68,68,0.4);
    animation:pulse-watch 2s ease-in-out infinite;
    transition:all 0.3s;
}
.watch-live-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 16px rgba(239,68,68,0.6);
}
.watch-live-btn svg{
    width:20px;
    height:20px;
}
@keyframes pulse-watch{
    0%,100%{box-shadow:0 4px 12px rgba(239,68,68,0.4)}
    50%{box-shadow:0 6px 16px rgba(239,68,68,0.6)}
}

/* Members Section */
.members-section{padding:20px 15px}
.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
body.dark .section-title{color:#e5e7eb}
.members-count{background:#e60012;color:#fff;padding:3px 8px;border-radius:10px;font-size:11px;font-weight:bold;min-width:25px;text-align:center}
.members-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:15px}
.member-card{background:#fff;border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.1);border:2px solid transparent}
body.dark .member-card{background:#1f2937;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.member-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,0.15);border-color:#e60012}
.member-avatar{width:100%;aspect-ratio:3/4;overflow:hidden;background:#f0f0f0;position:relative}
body.dark .member-avatar{background:#0a0e1a}
.member-avatar img{width:100%;height:100%;object-fit:cover;object-position:center top;display:block;transition:transform 0.3s}
.member-card:hover .member-avatar img{transform:scale(1.08)}
.member-info{padding:12px 8px;text-align:center}
.member-name{font-size:13px;font-weight:bold;color:#333;margin-bottom:4px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:30px}
body.dark .member-name{color:#e5e7eb}
.member-gen{font-size:10px;color:#6b7280;font-weight:600;line-height:1.3}
body.dark .member-gen{color:#9ca3af}

/* Birthday Member Card */
.birthday-member-card {
    border: 2px solid #f59e0b;
    position: relative;
}

.birthday-member-card .member-avatar {
    position: relative;
}

.birthday-member-card .member-avatar::after {
    content: '';
    position: absolute;
    top: 4px;
    right: 4px;
    background: #f59e0b;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    z-index: 2;
    box-shadow: 0 2px 6px rgba(245, 158, 11, 0.6);
}

.birthday-member-card .member-avatar::before {
    content: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='m7.994.013-.595.79a.747.747 0 0 0 .101 1.01V4H5a2 2 0 0 0-2 2v3H2a2 2 0 0 0-2 2v4a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-4a2 2 0 0 0-2-2h-1V6a2 2 0 0 0-2-2H8.5V1.806A.747.747 0 0 0 8.592.802zM4 6a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v.414a.9.9 0 0 1-.646-.268 1.914 1.914 0 0 0-2.708 0 .914.914 0 0 1-1.292 0 1.914 1.914 0 0 0-2.708 0A.9.9 0 0 1 4 6.414zm0 1.414c.49 0 .98-.187 1.354-.56a.914.914 0 0 1 1.292 0c.748.747 1.96.747 2.708 0a.914.914 0 0 1 1.292 0c.374.373.864.56 1.354.56V9H4zM1 11a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v.793l-.354.354a.914.914 0 0 1-1.293 0 1.914 1.914 0 0 0-2.707 0 .914.914 0 0 1-1.292 0 1.914 1.914 0 0 0-2.708 0 .914.914 0 0 1-1.292 0L1 11.793zm11.646 1.854a1.915 1.915 0 0 0 2.354.279V15H1v-1.867c.737.452 1.715.36 2.354-.28a.914.914 0 0 1 1.292 0c.748.748 1.96.748 2.708 0a.914.914 0 0 1 1.292 0c.748.748 1.96.748 2.707 0a.914.914 0 0 1 1.293 0Z'/%3E%3C/svg%3E");
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3;
}

.birthday-member-card .member-info {
    border-top: 2px solid #f59e0b;
}

/* No Shows Message */
.no-shows-message{text-align:center;padding:60px 20px;color:#6b7280}
body.dark .no-shows-message{color:#9ca3af}
.no-shows-icon{font-size:64px;margin-bottom:20px;opacity:0.5}
.no-shows-title{font-size:18px;font-weight:bold;margin-bottom:10px}
.no-shows-desc{font-size:14px;line-height:1.5;margin-bottom:30px}

/* Loading */
.loading{text-align:center;padding:80px 20px;color:#6b7280;display:flex;align-items:center;justify-content:center;gap:12px;flex-direction:column}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(0,0,0,0.1);border-top-color:#9ca3af;border-radius:50%;animation:spin 0.8s linear infinite}
body.dark .spinner{border-color:rgba(255,255,255,0.1);border-top-color:#9ca3af}

/* Footer */
.detail-footer{text-align:center;padding:15px;color:#6b7280;font-size:10px;border-top:1px solid #e5e7eb;margin-top:20px}
body.dark .detail-footer{color:#9ca3af;border-top-color:#374151}

/* Responsive Breakpoints */
@media (max-width:1024px){
    .container{max-width:90%;margin:130px auto 25px}
}

/* Large Mobile */
@media (max-width:768px){
    .container{max-width:95%;margin:120px auto 20px;border-radius:16px}
    .live-show-header{padding:20px 15px}
    .live-show-header h1{font-size:18px;margin-bottom:10px}
    .live-show-date-time{gap:12px;font-size:12px}
    .live-show-date-time div{gap:5px}
    .live-show-date-time svg{width:14px;height:14px}
    .watch-live-btn{padding:12px 24px;font-size:13px}
    .countdown-container{padding:10px 14px;margin:10px auto}
    .countdown-value{font-size:22px;padding:5px 8px;min-width:40px}
    .countdown-timer{gap:10px}
    .members-section{padding:15px}
    .section-title{font-size:15px;margin-bottom:12px}
    .birthday-member-card .member-avatar::after,
    .birthday-member-card .member-avatar::before {
        width: 20px;
        height: 20px;
        top: 3px;
        right: 3px;
    }
}

/* Small Mobile */
@media (max-width:480px){
    .main-header{position:sticky}
    .container{margin:0 auto 15px;border-radius:0;box-shadow:none;width:100%;max-width:100%}
    body.dark .container{box-shadow:none}
    .live-show-header{padding:15px}
    .live-show-header h1{font-size:16px;margin-bottom:8px}
    .status-badge-main{padding:5px 10px;font-size:11px;margin-bottom:8px}
    .live-dot-main,.upcoming-dot-main,.prelive-dot-main{width:6px;height:6px}
    .live-show-date-time{flex-direction:column;gap:6px;font-size:11px}
    .live-show-date-time div{gap:4px}
    .live-show-date-time svg{width:12px;height:12px}
    .watch-live-btn{
        padding:10px 20px;
        font-size:12px;
        margin:12px auto;
    }
    .watch-live-btn svg{width:16px;height:16px}
    .countdown-container{padding:8px 12px;margin:8px auto}
    .countdown-value{font-size:20px;padding:4px 6px;min-width:36px}
    .countdown-label{font-size:9px}
    .countdown-timer{gap:8px}
    .members-section{padding:12px}
    .section-title{font-size:14px;margin-bottom:10px}
    .members-grid{grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));gap:12px}
    .member-card{border-radius:10px}
    .member-info{padding:10px 6px}
    .member-name{font-size:12px;min-height:28px}
    .member-gen{font-size:9px}
    .detail-header{padding:10px 15px}
    .back-btn{font-size:14px;gap:4px}
    .back-btn svg{width:14px;height:14px}
    .detail-title{font-size:14px;margin:0 5px}
    .theme-toggle-detail{width:36px;height:36px}
    .theater-header{font-size:13px;padding:8px 15px}
    
    .birthday-badge-header {
        font-size: 10px;
        padding: 3px 8px;
        margin-top: 6px;
    }
    
    .birthday-member-card .member-avatar::after,
    .birthday-member-card .member-avatar::before {
        width: 18px;
        height: 18px;
        top: 3px;
        right: 3px;
    }
}

/* Extra Small Mobile */
@media (max-width:360px){
    .members-grid{grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));gap:10px}
    .live-show-header h1{font-size:15px}
    .status-badge-main{font-size:10px}
    .live-show-date-time{font-size:10px}
    .section-title{font-size:13px}
    .member-name{font-size:11px;min-height:26px}
    .member-gen{font-size:8px}
    .countdown-value{font-size:18px;padding:3px 5px;min-width:32px}
    .countdown-timer{gap:6px}
}

/* Landscape Mode */
@media (max-height:600px) and (orientation:landscape){
    .main-header{position:relative}
    .container{margin:20px auto}
    .live-show-header{padding:15px}
    .live-show-header h1{font-size:18px;margin-bottom:10px}
    .status-badge-main{margin-bottom:8px}
    .members-grid{grid-template-columns:repeat(auto-fill, minmax(100px, 1fr))}
}

/* ============= DESKTOP LAYOUT ============= */
@media (min-width: 1025px) {
    body {
        padding: 0;
    }
    
    .main-header {
        position: relative;
        background: #fff;
        border-bottom: 1px solid #ddd;
        margin-bottom: 30px;
    }
    
    .theater-header {
        color: #333;
        font-size: 16px;
        padding: 12px 20px;
        letter-spacing: 1px;
    }
    
    .detail-header {
        background: #fff;
        border-top: none;
        border-bottom: 1px solid #ddd;
    }
    
    body.dark .main-header {
        background: #111827;
        border-color: #1f2937;
    }
    
    body.dark .theater-header {
        color: #e5e7eb;
    }
    
    body.dark .detail-header {
        background: #111827;
        border-color: #1f2937;
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto 40px;
        border-radius: 15px;
    }
    
    .live-show-header {
        padding: 30px;
    }
    
    .live-show-header h1 {
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .status-badge-main {
        padding: 8px 16px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .live-dot-main, .upcoming-dot-main, .prelive-dot-main {
        width: 10px;
        height: 10px;
    }
    
    .live-show-date-time {
        gap: 30px;
        font-size: 14px;
        margin-bottom: 20px;
    }
    
    .live-show-date-time svg {
        width: 18px;
        height: 18px;
    }
    
    .countdown-container {
        max-width: 400px;
        padding: 15px 20px;
        margin: 15px auto;
    }
    
    .countdown-title {
        font-size: 14px;
    }
    
    .countdown-value {
        font-size: 26px;
        min-width: 50px;
        padding: 8px 12px;
    }
    
    .countdown-label {
        font-size: 11px;
    }
    
    .countdown-timer {
        gap: 15px;
    }
    
    .watch-live-btn {
        padding: 14px 30px;
        font-size: 15px;
        margin: 20px auto;
    }
    
    .watch-live-btn svg {
        width: 20px;
        height: 20px;
    }
    
    .members-section {
        max-width: 1000px;
        margin: 0 auto;
        padding: 30px;
    }
    
    .section-title {
        font-size: 20px;
        margin-bottom: 25px;
    }
    
    .members-count {
        font-size: 12px;
        padding: 4px 10px;
        min-width: 30px;
    }
    
    .members-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 20px;
    }
    
    .member-name {
        font-size: 13px;
        min-height: 30px;
    }
    
    .member-gen {
        font-size: 11px;
    }
    
    .birthday-member-card .member-avatar::after,
    .birthday-member-card .member-avatar::before {
        width: 28px;
        height: 28px;
        top: 6px;
        right: 6px;
    }
    
    .birthday-badge-header {
        font-size: 13px;
        padding: 6px 12px;
        margin-top: 10px;
    }
    
    .birthday-badge-header svg {
        width: 14px;
        height: 14px;
    }
    
    .detail-footer {
        padding: 15px;
        font-size: 11px;
        max-width: 1000px;
        margin: 0 auto;
        border: none;
        border-top: 1px solid #e5e7eb;
        margin-top: 30px;
    }
    
    body.dark .detail-footer {
        border-top-color: #374151;
    }
}
</style>
</head>
<body>
<header class="main-header">
  <div class="theater-header">JKT48 SHOW THEATER</div>
  <div class="detail-header">
    <button onclick="goBack()" class="back-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Kembali
    </button>
    <div class="detail-title">Live Show Detail</div>
    <div class="header-controls">
      <button class="theme-toggle-detail" onclick="toggleTheme()">
        <svg id="themeIconDetail" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
        </svg>
      </button>
    </div>
  </div>
</header>

<div class="container" id="container">
  <div class="loading">
    <div class="spinner"></div>
    <span>Memuat detail show...</span>
  </div>
</div>

<footer class="detail-footer">
  <p>JKT48 Show Theater • Detail Live Show</p>
</footer>

<script>
const SUPABASE_URL = "https://pprxfopqkvpeajeoxzig.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwcnhmb3Bxa3ZwZWFqZW94emlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTI4MTIsImV4cCI6MjA4MTgyODgxMn0.iXRO_dAHhtVHRLqGTresG_63RD2zIaopNXtXYNfthdg";

// ============= DAPATKAN PARAMETER URL DENGAN BENAR =============
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    
    const setlist = params.get('setlist') ? decodeURIComponent(params.get('setlist')) : '';
    const date = params.get('date') || '';
    const time = params.get('time') || '';
    
    console.log('URL Parameters:', { setlist, date, time });
    
    return { setlist, date, time };
}

const { setlist: SETLIST_NAME, date: SHOW_DATE, time: SHOW_TIME } = getUrlParams();

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const GEN_COLORS = {
  3: '#ec4899', 6: '#22c55e', 7: '#15803d', 8: '#1e40af',
  9: '#06b6d4', 10: '#38bdf8', 11: '#f97316', 12: '#fde047',
  13: '#facc15', 14: '#e879f9'
};

// ============= FUNGSI LIVE STATUS =============
const PRELIVE_MINUTES = 15;
const SHOW_DURATION_MINUTES = 155;

function getLiveStatus(show_date, show_time) {
    if (!show_date || !show_time) return 'FINISHED';
    
    const now = new Date();
    const showStart = new Date(`${show_date}T${show_time}`);
    const liveStart = new Date(showStart.getTime() - PRELIVE_MINUTES * 60000);
    const liveEnd = new Date(showStart.getTime() + SHOW_DURATION_MINUTES * 60000);

    if (now < liveStart) return 'UPCOMING';
    if (now >= liveStart && now < showStart) return 'PRELIVE';
    if (now >= showStart && now <= liveEnd) return 'LIVE';
    return 'FINISHED';
}

// ============= FUNGSI THEME =============
(function initializeTheme() {
  const savedTheme = localStorage.getItem('jkt48_theme') || 'light';
  const html = document.documentElement;
  const body = document.body;
  
  if (savedTheme === 'dark') {
    html.classList.add('dark');
    body.classList.add('dark');
    updateThemeIcon('dark');
  } else {
    html.classList.remove('dark');
    body.classList.remove('dark');
    updateThemeIcon('light');
  }
})();

function updateThemeIcon(theme) {
  const icon = document.getElementById('themeIconDetail');
  if (!icon) return;
  
  if (theme === 'dark') {
    icon.innerHTML = '<path d="M12,17a5,5,0,1,1,5-5A5,5,0,0,1,12,17Zm0-8a3,3,0,1,0,3,3A3,3,0,0,0,12,9Zm0-4a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41L6.34,5A1,1,0,0,0,4.93,6.34ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm.64,5.66a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71a1,1,0,0,0-1.41-1.41ZM12,19a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19Zm6.36-2.34a1,1,0,0,0-1.41,1.41l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-3.64-3.95a1,1,0,0,0,.7.29,1,1,0,0,0,.71-1.7l-.71-.71a1,1,0,0,0-1.41,1.41Z"/>';
  } else {
    icon.innerHTML = '<path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>';
  }
}

function toggleTheme() {
  const html = document.documentElement;
  const body = document.body;
  
  const isDark = body.classList.contains('dark');
  
  if (isDark) {
    html.classList.remove('dark');
    body.classList.remove('dark');
    localStorage.setItem('jkt48_theme', 'light');
    updateThemeIcon('light');
  } else {
    html.classList.add('dark');
    body.classList.add('dark');
    localStorage.setItem('jkt48_theme', 'dark');
    updateThemeIcon('dark');
  }
}

// ============= FUNGSI UNTUK MENDAPATKAN FOTO MEMBER =============
function getMemberPhotoUrl(memberName) {
  const formattedName = memberName.toLowerCase()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_]/g, '');
  
  return `img/${formattedName}.jpg`;
}

// ============= FUNGSI FORMAT TANGGAL GLOBAL =============
function formatDate(dateString) {
  if (!dateString) return 'Tanggal tidak tersedia';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    
    const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                       'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    const dayName = dayNames[date.getDay()];
    const day = date.getDate();
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    
    return `${dayName}, ${day} ${month} ${year}`;
  } catch (e) {
    return dateString;
  }
}

function adjustColor(color, amount) {
  const num = parseInt(color.replace('#', ''), 16);
  const r = Math.max(0, Math.min(255, (num >> 16) + amount));
  const g = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amount));
  const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
  return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
}

// ============= FUNGSI UTAMA LOAD DATA =============
async function loadData() {
  console.log('Loading data with params:', { SETLIST_NAME, SHOW_DATE, SHOW_TIME });
  
  if (!SETLIST_NAME || !SHOW_DATE) {
    showError('Data tidak lengkap. Silakan kembali ke halaman jadwal.');
    return;
  }

  try {
    let query = db
      .from('setlist_performance')
      .select('*')
      .eq('setlist_name', SETLIST_NAME)
      .eq('show_date', SHOW_DATE);
    
    if (SHOW_TIME) {
      const formattedTime = SHOW_TIME.includes(':') ? SHOW_TIME : `${SHOW_TIME}:00`;
      query = query.eq('show_time', formattedTime);
    }
    
    console.log('Executing query...');
    const { data: shows, error: showsError } = await query;
    
    if (showsError) {
      console.error('Database error:', showsError);
      throw showsError;
    }
    
    console.log('Query result:', shows);
    
    if (!shows || shows.length === 0) {
      console.log('No shows found, trying without time filter...');
      
      const retryQuery = db
        .from('setlist_performance')
        .select('*')
        .eq('setlist_name', SETLIST_NAME)
        .eq('show_date', SHOW_DATE);
      
      const { data: retryShows, error: retryError } = await retryQuery;
      
      if (retryError) throw retryError;
      
      if (!retryShows || retryShows.length === 0) {
        showNoShowsMessage();
        return;
      }
      
      console.log('Retry result:', retryShows);
      renderShowData(retryShows);
    } else {
      renderShowData(shows);
    }
    
  } catch (err) {
    console.error('Error loading data:', err);
    showError('Gagal memuat data show. Silakan coba lagi atau periksa koneksi internet.');
  }
}

async function renderShowData(shows) {
  const showData = shows || [];
  
  const firstShow = showData[0];
  if (!firstShow) {
    showNoShowsMessage();
    return;
  }
  
  const isBirthdayShow = firstShow.is_birthday_show || false;
  const birthdayMember = firstShow.birthday_member || null;
  const showTime = firstShow.show_time || '';
  
  const memberNames = [...new Set(showData.map(show => show.name))];
  
  const { data: members, error: membersError } = await db
    .from('members')
    .select('*')
    .in('name', memberNames);
  
  let membersData = [];
  
  if (membersError) {
    console.error('Error loading members:', membersError);
    membersData = [];
  } else {
    membersData = members || [];
  }
  
  renderPage(firstShow, showTime, isBirthdayShow, birthdayMember, membersData);
}

function renderPage(showData, showTime, isBirthdayShow, birthdayMember, membersData) {
  const date = new Date(SHOW_DATE);
  const dayNames = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
  const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  const formattedDate = `${dayNames[date.getDay()]}, ${date.getDate()} ${monthNames[date.getMonth()]} ${date.getFullYear()}`;
  
  const displayTime = showTime ? showTime.slice(0, 5) : '-';
  
  const status = getLiveStatus(SHOW_DATE, showTime);
  
  let statusBadge = '';
  let headerClass = status.toLowerCase();
  let watchLiveButton = '';
  let countdownHTML = '';
  
  if (status === 'UPCOMING') {
    statusBadge = `
      <div class="status-badge-main">
        <span class="upcoming-dot-main"></span>
        UPCOMING
      </div>
    `;
    
    countdownHTML = `
      <div class="countdown-container">
        <div class="countdown-title">Dimulai dalam:</div>
        <div class="countdown-timer" id="countdown">
          <div class="countdown-item">
            <div class="countdown-value" id="days">0</div>
            <div class="countdown-label">Hari</div>
          </div>
          <div class="countdown-item">
            <div class="countdown-value" id="hours">0</div>
            <div class="countdown-label">Jam</div>
          </div>
          <div class="countdown-item">
            <div class="countdown-value" id="minutes">0</div>
            <div class="countdown-label">Menit</div>
          </div>
          <div class="countdown-item">
            <div class="countdown-value" id="seconds">0</div>
            <div class="countdown-label">Detik</div>
          </div>
        </div>
      </div>
    `;
  } else if (status === 'PRELIVE') {
    statusBadge = `
      <div class="status-badge-main">
        <span class="prelive-dot-main"></span>
        PRELIVE (15 menit sebelum)
      </div>
    `;
    
    watchLiveButton = `
      <button class="watch-live-btn" onclick="window.open('https://www.idn.app/jkt48-official', '_blank')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
        Masuk ke Live Room
      </button>
    `;
    
    countdownHTML = `
      <div class="countdown-container">
        <div class="countdown-title">Live dimulai dalam:</div>
        <div class="countdown-timer" id="countdown">
          <div class="countdown-item">
            <div class="countdown-value" id="hours">0</div>
            <div class="countdown-label">Jam</div>
          </div>
          <div class="countdown-item">
            <div class="countdown-value" id="minutes">0</div>
            <div class="countdown-label">Menit</div>
          </div>
          <div class="countdown-item">
            <div class="countdown-value" id="seconds">0</div>
            <div class="countdown-label">Detik</div>
          </div>
        </div>
      </div>
    `;
  } else if (status === 'LIVE') {
    statusBadge = `
      <div class="status-badge-main">
        <span class="live-dot-main"></span>
        LIVE NOW
      </div>
    `;
    watchLiveButton = `
      <button class="watch-live-btn" onclick="window.open('https://www.idn.app/jkt48-official', '_blank')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
        Tonton Live di IDN App
      </button>
    `;
  } else {
    statusBadge = '<div class="status-badge-main">SHOW ENDED</div>';
  }
  
  let displayTitle = SETLIST_NAME || 'Show JKT48';
  if (isBirthdayShow && birthdayMember) {
    displayTitle += ` (STS ${birthdayMember})`;
  }
  
  document.getElementById('container').innerHTML = `
    <div class="live-show-header ${headerClass}">
      ${statusBadge}
      <h1>${displayTitle}</h1>
      ${isBirthdayShow && birthdayMember ? `
        <div class="birthday-badge-header">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="m7.994.013-.595.79a.747.747 0 0 0 .101 1.01V4H5a2 2 0 0 0-2 2v3H2a2 2 0 0 0-2 2v4a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-4a2 2 0 0 0-2-2h-1V6a2 2 0 0 0-2-2H8.5V1.806A.747.747 0 0 0 8.592.802zM4 6a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v.414a.9.9 0 0 1-.646-.268 1.914 1.914 0 0 0-2.708 0 .914.914 0 0 1-1.292 0 1.914 1.914 0 0 0-2.708 0A.9.9 0 0 1 4 6.414zm0 1.414c.49 0 .98-.187 1.354-.56a.914.914 0 0 1 1.292 0c.748.747 1.96.747 2.708 0a.914.914 0 0 1 1.292 0c.374.373.864.56 1.354.56V9H4zM1 11a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v.793l-.354.354a.914.914 0 0 1-1.293 0 1.914 1.914 0 0 0-2.707 0 .914.914 0 0 1-1.292 0 1.914 1.914 0 0 0-2.708 0 .914.914 0 0 1-1.292 0L1 11.793zm11.646 1.854a1.915 1.915 0 0 0 2.354.279V15H1v-1.867c.737.452 1.715.36 2.354-.28a.914.914 0 0 1 1.292 0c.748.748 1.96.748 2.708 0a.914.914 0 0 1 1.292 0c.748.748 1.96.748 2.707 0a.914.914 0 0 1 1.293 0Z"/>
          </svg>
          Birthday Show ${birthdayMember}
        </div>
      ` : ''}
      <div class="live-show-date-time">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          ${formattedDate}
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          ${displayTime} - Sampai selesai WIB
        </div>
      </div>
      ${countdownHTML}
      ${watchLiveButton}
    </div>
    
    <div class="members-section">
      <div class="section-title">
        <span>Member yang Tampil</span>
        <span class="members-count">${membersData.length}</span>
      </div>
      
      <div class="members-grid" id="membersGrid">
        ${renderMembersGrid(membersData, birthdayMember)}
      </div>
    </div>
  `;
  
  if (status === 'UPCOMING') {
    const showStart = new Date(`${SHOW_DATE}T${showTime}`);
    const liveStart = new Date(showStart.getTime() - PRELIVE_MINUTES * 60000);
    startCountdown(liveStart);
  } else if (status === 'PRELIVE') {
    const showStart = new Date(`${SHOW_DATE}T${showTime}`);
    startCountdown(showStart);
  }
}

function renderMembersGrid(membersData, birthdayMember) {
  if (!membersData || membersData.length === 0) {
    return '<div class="no-shows-message">Tidak ada data member</div>';
  }
  
  const sortedMembers = [...membersData].sort((a, b) => a.name.localeCompare(b.name));
  
  return sortedMembers.map(member => {
    const isBirthdayStar = birthdayMember && member.name.toLowerCase().includes(birthdayMember.toLowerCase());
    const photoUrl = getMemberPhotoUrl(member.name);
    
    return `
      <div class="member-card ${isBirthdayStar ? 'birthday-member-card' : ''}" onclick="openMemberPage('${member.name}')">
        <div class="member-avatar">
          <img src="${photoUrl}" 
               alt="${member.name}"
               loading="lazy"
               onerror="this.onerror=null; this.style.display='none'; this.parentNode.style.background='linear-gradient(135deg, ${GEN_COLORS[member.gen] || '#6366f1'}, ${adjustColor(GEN_COLORS[member.gen] || '#6366f1', -20)})'; this.parentNode.innerHTML='<div style=width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold>${member.name.charAt(0)}</div>'">>
        </div>
        <div class="member-info" style="border-top: 3px solid ${isBirthdayStar ? '#f59e0b' : (GEN_COLORS[member.gen] || '#6366f1')}">
          <div class="member-name">${member.name}</div>
          <div class="member-gen">Gen ${member.gen || '?'} • ${member.team || 'JKT48'}</div>
        </div>
      </div>
    `;
  }).join('');
}

function openMemberPage(memberName) {
  window.location.href = 'show.html?member=' + encodeURIComponent(memberName);
}

function showNoShowsMessage() {
  document.getElementById('container').innerHTML = `
    <div class="no-shows-message">
      <div class="no-shows-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <div class="no-shows-title">Show Tidak Ditemukan</div>
      <div class="no-shows-desc">
        Tidak ditemukan show untuk "${SETLIST_NAME}" pada tanggal ${formatDate(SHOW_DATE)}${SHOW_TIME ? ` jam ${SHOW_TIME}` : ''}.
        <br><br>
        Pastikan Anda memilih show dari halaman jadwal.
      </div>
      <button onclick="goBack()" style="background:#e60012;color:#fff;border:none;border-radius:12px;padding:12px 24px;font-size:14px;font-weight:600;cursor:pointer">
        Kembali ke Jadwal
      </button>
    </div>
  `;
}

function showError(message) {
  document.getElementById('container').innerHTML = `
    <div class="no-shows-message">
      <div class="no-shows-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <div class="no-shows-title">Terjadi Kesalahan</div>
      <div class="no-shows-desc">${message}</div>
      <button onclick="goBack()" style="background:#e60012;color:#fff;border:none;border-radius:12px;padding:12px 24px;font-size:14px;font-weight:600;cursor:pointer">
        Kembali ke Jadwal
      </button>
    </div>
  `;
}

function goBack() {
  window.location.href = 'schedule.html';
}

function startCountdown(targetDate) {
  const countdownInterval = setInterval(() => {
    const now = new Date().getTime();
    const distance = targetDate - now;
    
    if (distance < 0) {
      clearInterval(countdownInterval);
      loadData();
      return;
    }
    
    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
    
    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');
    
    if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
    if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
  }, 1000);
}

window.addEventListener('DOMContentLoaded', () => {
  loadData();
  
  setInterval(() => {
    loadData();
  }, 30000);
});
</script>
</body>
</html>