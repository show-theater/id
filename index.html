<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JKT48 Show Theater</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f5f5;color:#333;min-height:100vh;padding-bottom:60px;transition:background 0.3s,color 0.3s}
body.dark{background:#0a0e1a;color:#e5e7eb}
header{background:#e60012;padding:15px 20px;font-size:20px;font-weight:bold;color:#fff;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;min-height:60px}
.header-title{flex:1;text-align:center;margin:0;padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:20px}
.header-buttons{display:flex;gap:10px;align-items:center;flex-shrink:0}
.schedule-button,.theme-toggle{background:rgba(255,255,255,0.2);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:8px;transition:all 0.3s;flex-shrink:0}
.schedule-button:hover,.theme-toggle:hover{background:rgba(255,255,255,0.3);transform:scale(1.1)}
.schedule-button svg,.theme-toggle svg{width:20px;height:20px;transition:transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)}
.schedule-button:active svg,.theme-toggle:active svg{transform:scale(0.9)}
body.dark .schedule-button,body.dark .theme-toggle{background:rgba(0,0,0,0.2)}
.live-show-banner{color:white;padding:14px 20px;margin:0;border-bottom:3px solid #f59e0b;cursor:pointer;transition:all 0.3s;display:none;position:relative;overflow:hidden;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%)}
.live-show-banner.finished{background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%)}
.live-show-banner:hover{transform:translateY(-1px);opacity:0.95}
.live-show-banner::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.1) 50%,transparent 100%);animation:shimmer 3s infinite;pointer-events:none}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.live-show-content{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;max-width:1400px;margin:0 auto;width:100%}
.live-show-left{display:flex;align-items:center;gap:12px;flex:1}
.live-badge{background:rgba(255,255,255,0.2);padding:6px 12px;border-radius:20px;font-size:12px;font-weight:bold;display:flex;align-items:center;gap:6px;white-space:nowrap;flex-shrink:0}
.live-dot{width:8px;height:8px;background:#fff;border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.live-show-info{display:flex;flex-direction:column;gap:4px;flex:1}
.live-show-title{font-size:16px;font-weight:bold;margin:0;display:flex;align-items:center;gap:8px}
.live-show-time{font-size:13px;opacity:0.9;display:flex;align-items:center;gap:6px}
.live-show-right{display:flex;align-items:center;gap:10px}
.see-detail-link{color:#fff !important;font-size:13px;font-weight:bold;text-decoration:none;white-space:nowrap;padding:8px 16px;border-radius:20px;transition:all 0.3s;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3)}
.see-detail-link:hover{background:rgba(255,255,255,0.25);color:#fff !important;transform:translateX(4px)}
.top{padding:15px 20px;background:#fff;border-bottom:1px solid #ddd;text-align:center;transition:background 0.3s,border-color 0.3s}
body.dark .top{background:#1b1f3a;border-bottom:1px solid #2d3548}
.search-box{display:inline-block;width:100%;max-width:400px;position:relative}

/* ===== SEARCH ICON ===== */
.search-icon{
    position:absolute;
    right:14px;
    top:50%;
    transform:translateY(-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    z-index:2;
    color:#9ca3af;
    transition:color 0.3s;
}
.search-icon svg{width:16px;height:16px;display:block}
body.dark .search-icon{color:#6b7280}
.search-box:focus-within .search-icon{color:#e60012}
body.dark .search-box:focus-within .search-icon{color:#f87171}
.search-icon.hidden{display:none}
/* ======================== */

.search-box input{width:100%;padding:12px 44px 12px 20px;border-radius:25px;border:2px solid #D3D3D3;background:#fff;font-size:14px;outline:none;color:#333;transition:all 0.3s}
.search-box input::placeholder{color:#aaaaaa;opacity:1}
.search-box input:focus{border-color:#e60012}
body.dark .search-box input{background:#0a0e1a;color:#e5e7eb;border-color:#2d3548}
body.dark .search-box input::placeholder{color:#3d4558;opacity:1}
body.dark .search-box input:focus{border-color:#f87171}
.search-clear-btn{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:transparent;border:none;width:22px;height:22px;display:none;align-items:center;justify-content:center;cursor:pointer;padding:0;transition:transform 0.2s,opacity 0.2s;flex-shrink:0;z-index:3;opacity:0.5}
.search-clear-btn:hover{transform:translateY(-50%) scale(1.2);opacity:1}
.search-clear-btn:active{transform:translateY(-50%) scale(0.9)}
.search-clear-btn svg{width:14px;height:14px;display:block;stroke:#666}
.search-clear-btn:hover svg{stroke:#e60012}
.search-clear-btn.visible{display:flex}
body.dark .search-clear-btn svg{stroke:#9ca3af}
body.dark .search-clear-btn:hover svg{stroke:#f87171}
.last-update{text-align:center;padding:8px;font-size:11px;color:#9ca3af;background:#fff;transition:background 0.3s;display:flex;align-items:center;justify-content:center;gap:6px}
body.dark .last-update{background:#0a0e1a;color:#6b7280}
.last-update .spinner{width:12px;height:12px;border-width:2px}
.top-member-section{padding:15px 20px;background:#fff;border-bottom:1px solid #ddd;transition:background 0.3s,border-color 0.3s}
body.dark .top-member-section{background:#1b1f3a;border-bottom:1px solid #2d3548}
.top-member-title{font-size:12px;font-weight:600;color:#6b7280;margin-bottom:8px;text-align:center}
body.dark .top-member-title{color:#9ca3af}
.top-member-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.top-member-filter{padding:10px 18px;font-size:13px;border-radius:20px;border:2px solid transparent;cursor:pointer;font-weight:bold;background:#f0f0f0;color:#333;transition:all 0.3s;min-width:140px;text-align:center}
.top-member-filter.active{border-color:#e60012}
.top-member-filter.setlist-ramune{background:#00CED1;color:#fff}
body.dark .top-member-filter.setlist-ramune{background:#00CED1;color:#fff}
.top-member-filter.setlist-tte{background:#FF69B4;color:#fff}
body.dark .top-member-filter.setlist-tte{background:#FF69B4;color:#fff}
.top-member-filter.setlist-pertaruhan{background:#D30000;color:#fff}
body.dark .top-member-filter.setlist-pertaruhan{background:#900603;color:#fff}
.top-member-filter.setlist-pajama{background:#00006d;color:#fff}
body.dark .top-member-filter.setlist-pajama{background:#00006d;color:#fff}
body.dark .top-member-filter{background:#1f2937;color:#e5e7eb}
body.dark .top-member-filter.active{border-color:#f87171}
.filters{padding:15px 20px;background:#fff;border-bottom:1px solid #ddd;transition:background 0.3s,border-color 0.3s}
body.dark .filters{background:#1b1f3a;border-bottom:1px solid #2d3548}
.filter-section{margin-bottom:15px}
.filter-section:last-child{margin-bottom:0}
.filter-section-title{font-size:12px;font-weight:600;color:#6b7280;margin-bottom:8px;text-align:center}
body.dark .filter-section-title{color:#9ca3af}
.filter-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.filter{padding:10px 18px;font-size:13px;border-radius:20px;border:2px solid transparent;cursor:pointer;font-weight:bold;background:#f0f0f0;color:#333;transition:all 0.3s;min-width:120px;text-align:center}
.filter.active{border-color:#e60012;background:#fff}
.filter.gen-search{background:#6366f1;color:#fff}
body.dark .filter{background:#1f2937;color:#e5e7eb}
body.dark .filter.active{background:#0a0e1a;border-color:#f87171}
body.dark .filter.gen-search{background:#4f46e5;color:#fff}
.stats{text-align:center;padding:8px;font-size:12px;color:#9ca3af;background:#fff;transition:background 0.3s}
body.dark .stats{background:#0a0e1a;color:#6b7280}
.setlist-stats{text-align:center;padding:12px 20px;font-size:16px;font-weight:bold;color:#333;background:#fff;border-top:2px solid #f59e0b;display:none;margin:0;transition:background 0.3s,color 0.3s}
body.dark .setlist-stats{background:#1b1f3a;color:#e5e7eb;border-top:2px solid #d97706}
.container{padding:20px;display:grid;gap:15px;max-width:1400px;margin:0 auto;width:100%}
@media (max-width:767px){.container{grid-template-columns:repeat(4,1fr);gap:10px;padding:15px}}
@media (min-width:768px) and (max-width:1023px){.container{grid-template-columns:repeat(8,1fr);gap:12px;padding:18px}}
@media (min-width:1024px){.container{grid-template-columns:repeat(10,1fr);gap:15px;padding:20px}}
@media (min-width:1200px){.container{grid-template-columns:repeat(12,1fr);gap:16px;padding:24px}}
.card{background:#fff;border-radius:3.5px;overflow:hidden;text-align:center;cursor:pointer;transition:all 0.3s;display:flex;flex-direction:column;height:100%}
.card:hover{transform:translateY(-4px)}
body.dark .card{background:#1b1f3a}
.card.setlist-card{position:relative;border:2px solid transparent}
.card.setlist-card.rank-1{border-color:#f59e0b}
.card.setlist-card.rank-2{border-color:#9ca3af}
.card.setlist-card.rank-3{border-color:#d97706}
.avatar-container{width:100%;height:0;padding-bottom:133%;position:relative;overflow:hidden;background:#1a1a2e}
body.dark .avatar-container{background:#1a1a2e}
.avatar{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.3s}
.card:hover .avatar{transform:scale(1.05)}
.avatar-placeholder{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#1e1e2e;color:#5a5a7a;font-size:32px;font-weight:bold;letter-spacing:1px}
body.dark .avatar-placeholder{background:#1e1e2e;color:#5a5a7a}
.card-footer{padding:10px 8px;display:flex;flex-direction:column;flex-grow:1;min-height:90px;justify-content:space-between;align-items:center}
.gen-badge{display:inline-block;background:rgba(0,0,0,0.5);color:#fff;font-size:10px;font-weight:bold;padding:4px 10px;border-radius:15px;margin-bottom:6px;letter-spacing:0.5px;line-height:1.2;white-space:nowrap;text-align:center;min-width:50px;border:1px solid rgba(255,255,255,0.2)}
body.dark .gen-badge{background:rgba(0,0,0,0.6)}
.name-container{margin:6px 0;min-height:32px;display:flex;align-items:center;justify-content:center;width:100%}
.name{font-weight:bold;font-size:13px;color:#fff;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;max-height:2.6em;padding:0 4px}
.show-info{font-size:11px;color:rgba(255,255,255,0.95);line-height:1.3;margin:4px 0 8px 0;display:flex;align-items:center;justify-content:center;font-weight:700;min-height:18px}
.bar-container{margin-top:auto;padding-top:6px;width:100%;padding-left:8px;padding-right:8px;position:relative}
.bar{height:5px;background:rgba(0,0,0,0.2);border-radius:3px;overflow:hidden}
.bar span{display:block;height:100%;background:#fff;transition:width 0.5s ease}
body.dark .bar{background:rgba(255,255,255,0.2)}
body.dark .bar span{background:#fff}
.rank-badge{position:absolute;top:6px;left:6px;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;z-index:2}
.rank-badge.rank-1{background:#f59e0b;color:#000}
.rank-badge.rank-2{background:#9ca3af;color:#fff}
.rank-badge.rank-3{background:#d97706;color:#fff}
.rank-badge.rank-4,.rank-badge.rank-5,.rank-badge.rank-6,.rank-badge.rank-7,.rank-badge.rank-8,.rank-badge.rank-9,.rank-badge.rank-10{background:#4b5563;color:#fff}
.photo-setlist-badge{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,0.85);color:#fff;font-size:8px;padding:2px 6px;border-radius:8px;z-index:2;font-weight:bold;letter-spacing:0.5px}
.msg{grid-column:1/-1;text-align:center;padding:40px 20px;color:#9ca3af;font-size:14px}
body.dark .msg{color:#6b7280}
.loading{display:flex;align-items:center;justify-content:center;gap:8px;grid-column:1/-1;padding:60px 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:32px;height:32px;border:3px solid rgba(0,0,0,0.1);border-top-color:#f59e0b;border-radius:50%;animation:spin 0.8s linear infinite}
body.dark .spinner{border-color:rgba(255,255,255,0.1);border-top-color:#f59e0b}
.simple-message{grid-column:1/-1;text-align:center;padding:40px 20px;color:#6b7280;font-size:14px}
body.dark .simple-message{color:#9ca3af}
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.active{display:flex}
.modal{background:#fff;border-radius:16px;padding:24px;max-width:420px;width:90%;max-height:85vh;overflow-y:auto;animation:modalSlide 0.3s ease-out}
body.dark .modal{background:#1b1f3a;color:#e5e7eb;border:1px solid #2d3548}
@keyframes modalSlide{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #e5e7eb}
body.dark .modal-header{border-bottom-color:#2d3548}
.modal-title{font-size:18px;font-weight:bold;color:#e60012}
body.dark .modal-title{color:#f87171}
.modal-close{background:transparent;border:none;font-size:24px;cursor:pointer;color:#9ca3af;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s}
.modal-close:hover{background:#f3f4f6;color:#333}
body.dark .modal-close:hover{background:#374151;color:#e5e7eb}
.gen-grid{display:grid;gap:8px;margin:0 auto;width:100%}
@media (max-width:480px){.gen-grid{grid-template-columns:repeat(2,1fr)}}
@media (min-width:481px) and (max-width:767px){.gen-grid{grid-template-columns:repeat(3,1fr)}}
@media (min-width:768px){.gen-grid{grid-template-columns:repeat(3,1fr)}}
.gen-option{padding:12px 8px;border-radius:12px;border:2px solid transparent;cursor:pointer;font-weight:bold;text-align:center;transition:all 0.3s;font-size:14px;min-height:60px;display:flex;align-items:center;justify-content:center;flex-direction:column}
.gen-option:hover{transform:translateY(-2px)}
.gen-option.active{border-color:#e60012}
body.dark .gen-option.active{border-color:#f87171}
.gen-option.all-gen{background:#6366f1;color:#fff;grid-column:1/-1}
.gen-option.gen-3{background:#ec4899;color:#fff}
.gen-option.gen-6{background:#22c55e;color:#fff}
.gen-option.gen-7{background:#15803d;color:#fff}
.gen-option.gen-8{background:#1e40af;color:#fff}
.gen-option.gen-9{background:#06b6d4;color:#fff}
.gen-option.gen-10{background:#38bdf8;color:#fff}
.gen-option.gen-11{background:#f97316;color:#fff}
.gen-option.gen-12{background:#fde047;color:#000}
.gen-option.gen-13{background:#facc15;color:#000}
.gen-option.gen-14{background:#e879f9;color:#fff}
@media (max-width:767px){header{padding:12px 15px;min-height:55px}.header-title{font-size:18px;padding:0 5px}.header-buttons{gap:6px}.schedule-button,.theme-toggle{width:35px;height:35px}.schedule-button svg,.theme-toggle svg{width:18px;height:18px}.name{font-size:12px}.show-info{font-size:10px;margin:3px 0 6px 0}.gen-badge{font-size:9px;padding:3px 8px;min-width:45px}.bar{height:4px}.bar-container{padding-left:6px;padding-right:6px}.rank-badge{width:20px;height:20px;font-size:10px}.photo-setlist-badge{font-size:7px;padding:1px 4px}.card-footer{padding:8px 6px;min-height:85px}.name-container{min-height:28px}.top-member-filter{min-width:110px;padding:8px 12px;font-size:12px}.filter{min-width:100px;padding:8px 12px;font-size:12px}.live-show-content{flex-direction:column;align-items:stretch;gap:10px}.live-show-left{flex-direction:column;align-items:flex-start;gap:8px}.live-show-info{width:100%}.live-show-title{font-size:14px}.live-show-time{font-size:12px}.live-show-right{width:100%;justify-content:flex-end}}
@media (max-width:480px){.header-title{font-size:16px}.schedule-button,.theme-toggle{width:32px;height:32px}.schedule-button svg,.theme-toggle svg{width:16px;height:16px}.header-buttons{gap:4px}}
.detail-footer{text-align:center;padding:12px;color:#6b7280;font-size:10px;border-top:1px solid #e5e7eb;margin-top:20px;background:#fff;transition:background 0.3s,color 0.3s,border-color 0.3s}
body.dark .detail-footer{background:#0a0e1a;color:#9ca3af;border-top-color:#374151}

/* ===== NOTIF BUTTON ===== */
.notif-button{background:rgba(255,255,255,0.2);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:8px;transition:all 0.3s;flex-shrink:0;position:relative}
.notif-button:hover{background:rgba(255,255,255,0.3);transform:scale(1.1)}
.notif-button svg{width:20px;height:20px}
body.dark .notif-button{background:rgba(0,0,0,0.2)}
.notif-button.notif-active{background:rgba(255,255,255,0.35)}
.notif-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:#4ade80;border-radius:50%;border:2px solid #e60012;display:none}
.notif-button.notif-active .notif-dot{display:block}
/* ======================== */

/* Graduation Badge */
.graduation-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    color: white;
    font-size: 9px;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 12px;
    z-index: 2;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    gap: 4px;
}
.graduation-badge::before {
    content: 'ðŸŽ“';
    font-size: 10px;
}
.card.setlist-card .graduation-badge {
    top: 6px;
    left: 6px;
    font-size: 8px;
    padding: 3px 8px;
}
.card.graduated-member {
    opacity: 0.9;
}
.card.graduated-member:hover {
    opacity: 1;
}
.card-footer.graduated-bg {
    background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
}
</style>
</head>
<body>
<header>
    <div class="header-title">JKT48 SHOW THEATER</div>
    <div class="header-buttons">
        <button class="schedule-button" onclick="openSchedule()" title="Jadwal Show">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,4H18V3a1,1,0,0,0-2,0V4H8V3A1,1,0,0,0,6,3V4H5A3,3,0,0,0,2,7V19a3,3,0,0,0,3,3H19a3,3,0,0,0,3-3V7A3,3,0,0,0,19,4Zm1,15a1,1,0,0,1-1,1H5a1,1,0,0,1-1,1V12H20Zm0-9H4V7A1,1,0,0,1,5,6H6V7A1,1,0,0,0,8,7V6h8V7a1,1,0,0,0,2,0V6h1a1,1,0,0,1,1,1Z"/>
            </svg>
        </button>
        <button class="notif-button" id="notifBtn" onclick="toggleNotification()" title="Aktifkan Notifikasi Live Show">
            <span class="notif-dot" id="notifDot"></span>
            <svg id="notifIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18,16H6l-2,2V6a2,2,0,0,1,2-2H18a2,2,0,0,1,2,2V14A2,2,0,0,1,18,16Z" style="display:none"/>
                <path id="notifBellPath" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
        </button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
            <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"></svg>
        </button>
    </div>
</header>
<div class="live-show-banner" id="liveShowBanner" onclick="openLiveShowDetail()">
    <div class="live-show-content">
        <div class="live-show-left">
            <div class="live-badge" id="liveStatusBadge">
                <span class="live-dot"></span><span>LIVE NOW</span>
            </div>
            <div class="live-show-info">
                <h3 class="live-show-title" id="liveShowTitle">Loading...</h3>
                <div class="live-show-time" id="liveShowTime">-</div>
            </div>
        </div>
        <div class="live-show-right">
            <div class="see-detail-link">Lihat Detail</div>
        </div>
    </div>
</div>
<div class="top">
    <div class="search-box">
        <!-- Search icon (kaca pembesar) -->
        <span class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
        </span>
        <input type="text" id="searchInput" placeholder="Search Member JKT48" oninput="searchMember(); toggleClearBtn()">
        <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearch()" title="Hapus pencarian">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
</div>
<div class="last-update" id="lastUpdate">
    <div class="spinner"></div>
    <span>Loading...</span>
</div>
<div class="top-member-section">
    <div class="top-member-title">SETLIST PERFORMANCE</div>
    <div class="top-member-row">
        <button class="top-member-filter setlist-tte" onclick="showSetlist('tte')">Sambil Menggandeng Erat Tanganku</button>
        <button class="top-member-filter setlist-ramune" onclick="showSetlist('ramune')">Cara Meminum Ramune</button>
        <button class="top-member-filter setlist-pertaruhan" onclick="showSetlist('pertaruhan')">Pertaruhan Cinta</button>
        <button class="top-member-filter setlist-pajama" onclick="showSetlist('pajama')">Pajama Drive</button>
    </div>
</div>
<div class="filters">
    <div class="filter-section">
        <div class="filter-section-title">CARI GENERASI</div>
        <div class="filter-row">
            <button class="filter gen-search" onclick="openGenModal()">Pilih Generasi</button>
        </div>
    </div>
    <div class="filter-section">
        <div class="filter-section-title">FILTER TEAM</div>
        <div class="filter-row">
            <button class="filter team-filter" onclick="filterTeam('Love')" style="background:#ec4899;color:#fff">Love</button>
            <button class="filter team-filter" onclick="filterTeam('Dream')" style="background:#06b6d4;color:#fff">Dream</button>
            <button class="filter team-filter" onclick="filterTeam('Passion')" style="background:#fbbf24;color:#fff">Passion</button>
        </div>
    </div>
</div>
<div class="stats" id="stats"></div>
<div class="setlist-stats" id="setlistStats"></div>
<div class="container" id="list">
    <div class="loading">
        <div class="spinner"></div>
        <span>Loading data...</span>
    </div>
</div>

<footer class="detail-footer" id="mainFooter">
    <p>Â© 2026 Show Theater. Data diperbarui secara real-time</p>
</footer>

<div class="modal-overlay" id="genModal" onclick="closeModalOnOverlay(event)">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Pilih Generasi</div>
            <button class="modal-close" onclick="closeGenModal()">Ã—</button>
        </div>
        <div class="gen-grid">
            <div class="gen-option all-gen" onclick="selectGen('all')">All Generasi</div>
            <div class="gen-option gen-3" onclick="selectGen(3)">Gen 3</div>
            <div class="gen-option gen-6" onclick="selectGen(6)">Gen 6</div>
            <div class="gen-option gen-7" onclick="selectGen(7)">Gen 7</div>
            <div class="gen-option gen-8" onclick="selectGen(8)">Gen 8</div>
            <div class="gen-option gen-9" onclick="selectGen(9)">Gen 9</div>
            <div class="gen-option gen-10" onclick="selectGen(10)">Gen 10</div>
            <div class="gen-option gen-11" onclick="selectGen(11)">Gen 11</div>
            <div class="gen-option gen-12" onclick="selectGen(12)">Gen 12</div>
            <div class="gen-option gen-13" onclick="selectGen(13)">Gen 13</div>
            <div class="gen-option gen-14" onclick="selectGen(14)">Gen 14</div>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = "https://pprxfopqkvpeajeoxzig.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwcnhmb3Bxa3ZwZWFqZW94emlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTI4MTIsImV4cCI6MjA4MTgyODgxMn0.iXRO_dAHhtVHRLqGTresG_63RD2zIaopNXtXYNfthdg";

const GEN_COLORS = {
    3: '#ec4899', 6: '#22c55e', 7: '#15803d', 8: '#1e40af',
    9: '#06b6d4', 10: '#38bdf8', 11: '#f97316', 12: '#fde047',
    13: '#facc15', 14: '#e879f9'
};

const SETLIST_DATA = {
    ramune: {id: 'ramune', title: 'Cara Meminum Ramune', members: {}},
    tte: {id: 'tte', title: 'Te Wo Tsunaginagara', members: {}},
    pertaruhan: {id: 'pertaruhan', title: 'Pertaruhan Cinta', members: {}},
    pajama: {id: 'pajama', title: 'Pajama Drive', members: {}}
};

const TIME_CONFIG = {LIVE_BEFORE: 15, LIVE_DURATION: 155};
const MILESTONE = 1000;
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let members = [], 
    membersMap = {},
    allMembersData = [], 
    currentGen = 'all', 
    currentTeam = 'all', 
    searchQuery = '', 
    isDataLoaded = false, 
    scrollSaveTimeout, 
    currentSetlistView = null, 
    currentLiveShowData = null, 
    liveShowRefreshInterval = null,
    latestUpdateTime = null,
    allShowsData = [];

// ============= FUNGSI LIVE STATUS =============
function getLiveStatus(showDate, showTime) {
    if (!showDate || !showTime) return 'FINISHED';
    const now = new Date();
    const showDateTime = new Date(`${showDate}T${showTime}`);
    const liveStart = new Date(showDateTime.getTime() - (TIME_CONFIG.LIVE_BEFORE * 60 * 1000));
    const liveEnd = new Date(showDateTime.getTime() + (TIME_CONFIG.LIVE_DURATION * 60 * 1000));
    if (now < liveStart) return 'UPCOMING';
    if (now >= liveStart && now <= liveEnd) return 'LIVE';
    return 'FINISHED';
}

// ============= SEARCH CLEAR BUTTON =============
function toggleClearBtn() {
    const btn = document.getElementById('searchClearBtn');
    const icon = document.querySelector('.search-icon');
    const input = document.getElementById('searchInput');
    const hasValue = input.value.length > 0;
    if (btn) btn.classList.toggle('visible', hasValue);
    if (icon) icon.style.display = hasValue ? 'none' : 'flex';
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    toggleClearBtn();
    searchMember();
    document.getElementById('searchInput').focus();
}

// ============= FUNGSI THEME =============
(function initializeTheme() {
    const savedTheme = localStorage.getItem('jkt48_theme') || 'light';
    const html = document.documentElement;
    const body = document.body;
    if (savedTheme === 'dark') {
        html.classList.add('dark');
        body.classList.add('dark');
        updateThemeIcon('dark');
    } else {
        html.classList.remove('dark');
        body.classList.remove('dark');
        updateThemeIcon('light');
    }
})();

function updateThemeIcon(theme) {
    const icon = document.getElementById('themeIcon');
    if (!icon) return;
    if (theme === 'dark') {
        icon.innerHTML = '<path d="M12,17a5,5,0,1,1,5-5A5,5,0,0,1,12,17Zm0-8a3,3,0,1,0,3,3A3,3,0,0,0,12,9Zm0-4a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41L6.34,5A1,1,0,0,0,4.93,6.34ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm.64,5.66a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71a1,1,0,0,0-1.41-1.41ZM12,19a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19Zm6.36-2.34a1,1,0,0,0-1.41,1.41l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-3.64-3.95a1,1,0,0,0,.7.29,1,1,0,0,0,.71-1.7l-.71-.71a1,1,0,0,0-1.41,1.41Z"/>';
    } else {
        icon.innerHTML = '<path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>';
    }
}

function toggleTheme() {
    const html = document.documentElement;
    const body = document.body;
    const isDark = body.classList.contains('dark');
    if (isDark) {
        html.classList.remove('dark');
        body.classList.remove('dark');
        localStorage.setItem('jkt48_theme', 'light');
        updateThemeIcon('light');
    } else {
        html.classList.add('dark');
        body.classList.add('dark');
        localStorage.setItem('jkt48_theme', 'dark');
        updateThemeIcon('dark');
    }
}

function openSchedule() {
    window.location.href = 'schedule.html';
}

// ============= LIVE SHOW BANNER =============
async function checkLiveShows() {
    try {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const todayShows = allShowsData.filter(show => show.show_date === today);
        if (todayShows.length === 0) return null;
        const liveShows = [];
        todayShows.forEach(show => {
            const status = getLiveStatus(show.show_date, show.show_time);
            if (status === 'LIVE') {
                const member = membersMap[show.member_id];
                if (member) {
                    liveShows.push({ ...show, memberName: member.name, status });
                }
            }
        });
        if (liveShows.length > 0) return prepareShowData(liveShows);
        return null;
    } catch (err) {
        console.error('Error in checkLiveShows:', err);
        return null;
    }
}

function prepareShowData(shows) {
    const groupedShows = {};
    shows.forEach(show => {
        const key = `${show.setlist_name}|${show.show_date}|${show.show_time}`;
        if (!groupedShows[key]) {
            groupedShows[key] = {
                setlistName: show.setlist_name,
                showDate: show.show_date,
                showTime: show.show_time,
                members: [],
                isBirthdayShow: show.is_birthday_show || false,
                birthdayMember: show.birthday_member || null,
                isGraduationShow: show.is_graduation_show || false,
                graduationMember: show.graduation_member || null,
                status: show.status
            };
        }
        if (show.memberName && !groupedShows[key].members.includes(show.memberName)) {
            groupedShows[key].members.push(show.memberName);
        }
    });
    const sortedKeys = Object.keys(groupedShows).sort((a, b) => {
        const timeA = a.split('|')[2];
        const timeB = b.split('|')[2];
        return timeA.localeCompare(timeB);
    });
    if (sortedKeys.length === 0) return null;
    const firstShow = groupedShows[sortedKeys[0]];
    return {
        name: firstShow.setlistName,
        shows: firstShow.members,
        memberCount: firstShow.members.length,
        earliestTime: firstShow.showTime,
        isBirthdayShow: firstShow.isBirthdayShow,
        birthdayMember: firstShow.birthdayMember,
        isGraduationShow: firstShow.isGraduationShow,
        graduationMember: firstShow.graduationMember,
        status: firstShow.status
    };
}

async function updateLiveShowBanner() {
    const banner = document.getElementById('liveShowBanner');
    const title = document.getElementById('liveShowTitle');
    const timeElement = document.getElementById('liveShowTime');
    const badge = document.getElementById('liveStatusBadge');
    try {
        const showData = await checkLiveShows();
        currentLiveShowData = showData;
        if (!showData) {
            banner.style.display = 'none';
            return;
        }
        banner.style.display = 'block';
        let displayTitle = showData.name;
        if (showData.isBirthdayShow && showData.birthdayMember) displayTitle += ` (STS ${showData.birthdayMember})`;
        if (showData.isGraduationShow && showData.graduationMember) displayTitle += ` (Graduation ${showData.graduationMember})`;
        title.textContent = displayTitle;
        banner.className = 'live-show-banner';
        badge.className = 'live-badge';
        if (showData.status === 'LIVE') {
            banner.classList.add('live-now');
            badge.innerHTML = '<span class="live-dot"></span><span>LIVE</span>';
        } else {
            banner.classList.add('finished');
            badge.innerHTML = '<span>SHOW ENDED</span>';
        }
        if (showData.earliestTime) {
            const timeStr = showData.earliestTime.slice(0, 5);
            timeElement.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> ${timeStr} WIB â€¢ ${showData.memberCount} member`;
        } else {
            timeElement.textContent = `Hari ini â€¢ ${showData.memberCount} member`;
        }
    } catch (err) {
        console.error('Error updating banner:', err);
        banner.style.display = 'none';
    }
}

function openLiveShowDetail() {
    if (!currentLiveShowData) return;
    const setlistParam = encodeURIComponent(currentLiveShowData.name);
    const dateParam = encodeURIComponent(new Date().toISOString().split('T')[0]);
    const timeParam = encodeURIComponent(currentLiveShowData.earliestTime);
    localStorage.setItem('jkt48_selected_setlist', currentLiveShowData.name);
    localStorage.setItem('jkt48_selected_date', dateParam);
    localStorage.setItem('jkt48_selected_time', currentLiveShowData.earliestTime);
    window.location.href = `liveshow.html?setlist=${setlistParam}&date=${dateParam}&time=${timeParam}`;
}

// ============= LOAD DATA =============
async function loadData() {
    try {
        const { data: membersData, error: membersError } = await db
            .from('members')
            .select('id, name, gen, team, show, status')
            .order('show', { ascending: false });
        if (membersError) throw membersError;
        members = membersData || [];
        allMembersData = [...members];
        membersMap = {};
        members.forEach(member => { membersMap[member.id] = member; });
        await loadAllShows();
        await updateLiveShowBanner();
        await updateFooterWithLatestUpdate();
        restoreState();
        if (members.length === 0) {
            document.getElementById('list').innerHTML = '<div class="msg">Tidak ada data</div>';
            document.getElementById('lastUpdate').innerHTML = 'Tidak ada data';
        } else {
            await updateLastUpdate();
            renderMembers();
            updateStats();
            isDataLoaded = true;
            setTimeout(() => restoreScrollPosition(), 100);
        }
    } catch (err) {
        console.error('Error:', err);
        document.getElementById('list').innerHTML = '<div class="msg" style="color:#ef4444">Error: ' + err.message + '</div>';
        document.getElementById('lastUpdate').innerHTML = 'Error';
    }
}

async function loadAllShows() {
    try {
        const { data: showsData, error: showsError } = await db
            .from('setlist_performance')
            .select('*')
            .order('show_date', { ascending: false })
            .order('show_time', { ascending: false });
        if (showsError) throw showsError;
        allShowsData = showsData || [];
        processSetlistCounts();
    } catch (err) {
        console.error('Error loading shows:', err);
    }
}

function processSetlistCounts() {
    try {
        Object.keys(SETLIST_DATA).forEach(key => { SETLIST_DATA[key].members = {}; });
        members.forEach(member => {
            Object.keys(SETLIST_DATA).forEach(key => { SETLIST_DATA[key].members[member.name] = 0; });
        });
        const showCountMap = {};
        allShowsData.forEach(show => {
            const member = membersMap[show.member_id];
            if (!member || !show.setlist_name) return;
            const memberName = member.name;
            const setlistName = show.setlist_name.toLowerCase().trim();
            let key = null;
            if (setlistName.includes('ramune')) key = 'ramune';
            else if (setlistName.includes('tsunaginagara') || setlistName.includes('tte') || setlistName.includes('te wo')) key = 'tte';
            else if (setlistName.includes('pertaruhan')) key = 'pertaruhan';
            else if (setlistName.includes('pajama')) key = 'pajama';
            if (key) {
                const mapKey = `${memberName}_${key}`;
                showCountMap[mapKey] = (showCountMap[mapKey] || 0) + 1;
            }
        });
        Object.keys(showCountMap).forEach(mapKey => {
            const parts = mapKey.split('_');
            const key = parts.pop();
            const memberName = parts.join('_');
            if (SETLIST_DATA[key] && memberName) {
                SETLIST_DATA[key].members[memberName] = showCountMap[mapKey];
            }
        });
    } catch (err) {
        console.error('Error processing setlist counts:', err);
    }
}

async function updateFooterWithLatestUpdate() {
    try {
        const { data, error } = await db
            .from('setlist_performance')
            .select('updated_at')
            .order('updated_at', { ascending: false })
            .limit(1);
        if (!error && data && data.length > 0 && data[0].updated_at) {
            latestUpdateTime = new Date(data[0].updated_at);
            updateFooter();
            return true;
        }
        return false;
    } catch (err) {
        console.error('Error update footer:', err);
        return false;
    }
}

function updateFooter() {
    if (!latestUpdateTime) return;
    const day = latestUpdateTime.getDate();
    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    const formatted = `${day} ${monthNames[latestUpdateTime.getMonth()]}`;
    const footer = document.getElementById('mainFooter');
    if (footer) footer.innerHTML = `<p>Â© 2026 Show Theater. Data diperbarui secara real-time</p>`;
}

async function updateLastUpdate() {
    if (members.length === 0) return;
    try {
        const { data, error } = await db
            .from('setlist_performance')
            .select('updated_at')
            .order('updated_at', { ascending: false })
            .limit(1);
        if (!error && data && data.length > 0 && data[0].updated_at) {
            const rawDate = data[0].updated_at; const date = new Date(rawDate.endsWith('Z') || rawDate.includes('+') ? rawDate : rawDate + 'Z');
            const monthNames = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Oct','Nov','Des'];
            const hours = String(date.getHours()).padStart(2,'0'); const minutes = String(date.getMinutes()).padStart(2,'0'); document.getElementById('lastUpdate').innerHTML = `Update: ${date.getDate()} ${monthNames[date.getMonth()]} ${date.getFullYear()}, ${hours}:${minutes}`;
            return;
        }
    } catch (err) {
        console.error('Error update time:', err);
    }
    document.getElementById('lastUpdate').innerHTML = 'Data tersedia';
}

function openMemberPage(name) {
    saveCurrentState();
    window.location.href = (currentSetlistView ? 'show.html' : 'detail.html') + '?member=' + encodeURIComponent(name);
}

// ============= RENDER MEMBERS =============
function renderMembers() {
    const list = document.getElementById('list');
    searchQuery = document.getElementById('searchInput').value.trim();
    if (currentSetlistView) {
        renderSetlistMembers();
        return;
    }
    let filtered = members.filter(m => {
        const matchGen = currentGen === 'all' || m.gen === currentGen;
        const matchTeam = currentTeam === 'all' || m.team === currentTeam;
        const matchSearch = !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase());
        return matchGen && matchTeam && matchSearch;
    });
    if (filtered.length === 0) {
        let msg = '';
        if (searchQuery) msg = `Tidak ada "${searchQuery}"`;
        else if (currentTeam !== 'all') msg = `Belum Tersedia ${currentTeam}`;
        else if (currentGen !== 'all') msg = `Belum ada Gen ${currentGen}`;
        else msg = 'Belum ada data';
        list.innerHTML = `<div class="simple-message">${msg}</div>`;
        return;
    }
    list.innerHTML = '';
    filtered.sort((a, b) => b.show - a.show).forEach(m => {
        const percent = Math.min(100, (m.show / MILESTONE) * 100);
        const color = GEN_COLORS[m.gen] || '#6366f1';
        const isGraduated = m.status === 'graduated';
        const card = document.createElement('div');
        card.className = isGraduated ? 'card graduated-member' : 'card';
        card.addEventListener('click', () => openMemberPage(m.name));
        const genText = m.gen ? `Gen ${m.gen}` : 'Gen ?';
        const graduationBadge = isGraduated ? '<div class="graduation-badge">GRADUATED</div>' : '';
        const footerColor = isGraduated ? '#6b7280' : color;
        card.innerHTML = `
            <div class="avatar-container">
                <img class="avatar" src="img/${m.name.toLowerCase()}.jpg" alt="${m.name}" loading="lazy" onerror="this.onerror=null;this.style.display='none';this.parentNode.innerHTML='<div class=&quot;avatar-placeholder&quot;>${m.name.charAt(0)}</div>'">
                ${graduationBadge}
            </div>
            <div class="card-footer" style="background-color:${footerColor}">
                <div class="gen-badge">${genText}</div>
                <div class="name-container">
                    <div class="name">${m.name}</div>
                </div>
                <div class="show-info">${m.show} show</div>
                <div class="bar-container">
                    <div class="bar"><span style="width:${percent}%"></span></div>
                </div>
            </div>
        `;
        list.appendChild(card);
    });
}

function renderSetlistMembers() {
    const list = document.getElementById('list');
    const setlistData = SETLIST_DATA[currentSetlistView];
    if (!setlistData) {
        list.innerHTML = '<div class="simple-message">Data tidak tersedia</div>';
        return;
    }
    list.innerHTML = '';
    const arr = members.map(m => ({
        name: m.name,
        shows: setlistData.members[m.name] || 0,
        memberData: m
    })).sort((a, b) => b.shows !== a.shows ? b.shows - a.shows : a.name.localeCompare(b.name));
    const active = arr.filter(m => m.shows > 0);
    document.getElementById('setlistStats').innerHTML = setlistData.title;
    document.getElementById('setlistStats').style.display = 'block';
    const badges = { ramune: 'CMR', tte: 'TWT', pertaruhan: 'PC', pajama: 'PD' };
    const badge = badges[currentSetlistView] || '';
    let maxShows = active.length > 0 ? Math.max(...active.map(m => m.shows)) : 0;
    let scale = 15;
    if (maxShows > 0) {
        if (maxShows <= 10) scale = 15;
        else if (maxShows <= 50) scale = maxShows + 10;
        else if (maxShows <= 100) scale = maxShows + 20;
        else if (maxShows <= 200) scale = maxShows + 30;
        else scale = maxShows + 40;
    }
    active.forEach((m, i) => {
        const rank = i + 1;
        const percent = Math.min(100, (m.shows / scale) * 100);
        const color = GEN_COLORS[m.memberData.gen] || '#6366f1';
        const isGraduated = m.memberData.status === 'graduated';
        const card = document.createElement('div');
        card.className = `card setlist-card ${rank <= 3 ? 'rank-' + rank : ''}`;
        if (isGraduated) card.classList.add('graduated-member');
        card.addEventListener('click', () => openMemberPage(m.name));
        const rankBadge = rank <= 10 ? `<div class="rank-badge rank-${rank}">${rank}</div>` : '';
        const graduationBadge = isGraduated ? '<div class="graduation-badge">GRADUATED</div>' : '';
        const genText = m.memberData.gen ? `Gen ${m.memberData.gen}` : 'Gen ?';
        const footerColor = isGraduated ? '#6b7280' : color;
        card.innerHTML = `
            <div class="avatar-container">
                <img class="avatar" src="img/${m.name.toLowerCase()}.jpg" alt="${m.name}" loading="lazy" onerror="this.onerror=null;this.style.display='none';this.parentNode.innerHTML='<div class=&quot;avatar-placeholder&quot;>${m.name.charAt(0)}</div>'">
                ${rankBadge}
                ${graduationBadge}
                <div class="photo-setlist-badge">${badge}</div>
            </div>
            <div class="card-footer" style="background-color:${footerColor}">
                <div class="gen-badge">${genText}</div>
                <div class="name-container">
                    <div class="name">${m.name}</div>
                </div>
                <div class="show-info">${m.shows} show</div>
                <div class="bar-container">
                    <div class="bar"><span style="width:${percent}%"></span></div>
                </div>
            </div>
        `;
        list.appendChild(card);
    });
    if (active.length === 0) {
        list.innerHTML = '<div class="simple-message">Belum ada member</div>';
    }
}

function updateStats() {
    const filtered = members.filter(m => {
        const matchGen = currentGen === 'all' || m.gen === currentGen;
        const matchTeam = currentTeam === 'all' || m.team === currentTeam;
        const matchSearch = !searchQuery || m.name.toLowerCase().includes(searchQuery.toLowerCase());
        return matchGen && matchTeam && matchSearch;
    });
    const total = filtered.length;
    const totalShows = filtered.reduce((sum, m) => sum + m.show, 0);
    const graduatedCount = filtered.filter(m => m.status === 'graduated').length;
    let txt = `${total} members â€¢ ${totalShows.toLocaleString()} total shows`;
    if (graduatedCount > 0) txt += ` â€¢ ${graduatedCount} Graduated`;
    if (currentGen !== 'all') txt += ' â€¢ Gen ' + currentGen;
    if (currentTeam !== 'all') txt += ' â€¢ ' + currentTeam;
    document.getElementById('stats').innerHTML = txt;
}

// ============= FILTER & SEARCH =============
function searchMember() {
    searchQuery = document.getElementById('searchInput').value;
    currentSetlistView = null;
    currentGen = 'all';
    currentTeam = 'all';
    document.querySelectorAll('.top-member-filter').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.team-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById('stats').style.display = 'block';
    document.getElementById('setlistStats').style.display = 'none';
    renderMembers();
    updateStats();
    saveCurrentState();
}

function filterTeam(team) {
    currentTeam = team;
    currentGen = 'all';
    currentSetlistView = null;
    searchQuery = '';
    document.getElementById('searchInput').value = '';
    toggleClearBtn();
    document.querySelectorAll('.filter').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.top-member-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById('stats').style.display = 'block';
    document.getElementById('setlistStats').style.display = 'none';
    event.target.classList.add('active');
    renderMembers();
    updateStats();
    saveCurrentState();
}

function showSetlist(type) {
    currentSetlistView = type;
    currentGen = 'all';
    currentTeam = 'all';
    searchQuery = '';
    document.getElementById('searchInput').value = '';
    toggleClearBtn();
    document.querySelectorAll('.filter').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.team-filter').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.top-member-filter').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('stats').style.display = 'none';
    document.getElementById('setlistStats').style.display = 'block';
    renderSetlistMembers();
    saveCurrentState();
}

// ============= STATE MANAGEMENT =============
function saveCurrentState() {
    sessionStorage.setItem('jkt48_current_gen', currentGen);
    sessionStorage.setItem('jkt48_current_team', currentTeam);
    sessionStorage.setItem('jkt48_search_query', searchQuery);
    sessionStorage.setItem('jkt48_setlist_view', currentSetlistView || '');
    sessionStorage.setItem('jkt48_scroll_position', window.scrollY);
}

function restoreState() {
    const savedGen = sessionStorage.getItem('jkt48_current_gen');
    const savedTeam = sessionStorage.getItem('jkt48_current_team');
    const savedSearch = sessionStorage.getItem('jkt48_search_query');
    const savedSetlist = sessionStorage.getItem('jkt48_setlist_view');
    if (savedGen && savedGen !== 'null') currentGen = savedGen === 'all' ? 'all' : parseInt(savedGen);
    if (savedTeam && savedTeam !== 'null') currentTeam = savedTeam;
    if (savedSearch && savedSearch !== 'null') {
        searchQuery = savedSearch;
        document.getElementById('searchInput').value = searchQuery;
        toggleClearBtn();
    }
    if (savedSetlist && savedSetlist !== 'null' && savedSetlist !== '') {
        currentSetlistView = savedSetlist;
        if (currentSetlistView) {
            document.getElementById('stats').style.display = 'none';
            document.getElementById('setlistStats').style.display = 'block';
            document.querySelectorAll('.top-member-filter').forEach(btn => {
                btn.classList.remove('active');
                const txt = btn.textContent.toLowerCase();
                if ((currentSetlistView === 'ramune' && txt.includes('ramune')) ||
                    (currentSetlistView === 'tte' && txt.includes('menggandeng')) ||
                    (currentSetlistView === 'pertaruhan' && txt.includes('pertaruhan')) ||
                    (currentSetlistView === 'pajama' && txt.includes('pajama'))) {
                    btn.classList.add('active');
                }
            });
        }
    } else {
        currentSetlistView = null;
    }
    if (currentTeam !== 'all') {
        document.querySelectorAll('.team-filter').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.includes(currentTeam)) btn.classList.add('active');
        });
    }
}

function restoreScrollPosition() {
    const saved = sessionStorage.getItem('jkt48_scroll_position');
    if (saved && saved !== 'null') {
        setTimeout(() => window.scrollTo({ top: parseInt(saved), behavior: 'instant' }), 50);
    }
}

window.addEventListener('scroll', () => {
    clearTimeout(scrollSaveTimeout);
    scrollSaveTimeout = setTimeout(() => {
        if (isDataLoaded) sessionStorage.setItem('jkt48_scroll_position', window.scrollY);
    }, 150);
});

window.addEventListener('beforeunload', () => saveCurrentState());

// ============= MODAL GEN =============
function openGenModal() {
    document.getElementById('genModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
        document.querySelectorAll('.gen-option').forEach(option => {
            option.classList.remove('active');
            if (option.classList.contains('all-gen') && currentGen === 'all') {
                option.classList.add('active');
            } else if (option.textContent.includes('Gen')) {
                const genNum = parseInt(option.textContent.replace('Gen ', '').trim());
                if (genNum === currentGen) option.classList.add('active');
            }
        });
    }, 10);
}

function closeGenModal() {
    document.getElementById('genModal').classList.remove('active');
    document.body.style.overflow = 'auto';
}

function closeModalOnOverlay(e) {
    if (e.target === document.getElementById('genModal')) closeGenModal();
}

function selectGen(gen) {
    currentGen = gen;
    currentTeam = 'all';
    currentSetlistView = null;
    searchQuery = '';
    document.getElementById('searchInput').value = '';
    toggleClearBtn();
    document.querySelectorAll('.team-filter').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.top-member-filter').forEach(btn => btn.classList.remove('active'));
    document.getElementById('stats').style.display = 'block';
    document.getElementById('setlistStats').style.display = 'none';
    closeGenModal();
    renderMembers();
    updateStats();
    saveCurrentState();
}

// ============= PUSH NOTIFICATION =============
const VAPID_PUBLIC_KEY = 'BDV5GgZafvlEa3ArE29_fuMuoWPLEuofOHSgaJNi6RiVWhIcAJTIdjc0yFGBnxXu26gqBwMzqV3oB34-INKruel';

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
}

let swRegistration = null;

async function initServiceWorker() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
    try {
        swRegistration = await navigator.serviceWorker.register('/service-worker.js');
        console.log('âœ… Service Worker registered');
        updateNotifButtonState();
    } catch (err) {
        console.error('SW Error:', err);
    }
}

async function isSubscribed() {
    if (!swRegistration) return false;
    const sub = await swRegistration.pushManager.getSubscription();
    return !!sub;
}

async function updateNotifButtonState() {
    const btn = document.getElementById('notifBtn');
    if (!btn) return;
    const subscribed = await isSubscribed();
    if (subscribed) {
        btn.classList.add('notif-active');
        btn.title = 'Notifikasi Aktif â€“ Klik untuk nonaktifkan';
    } else {
        btn.classList.remove('notif-active');
        btn.title = 'Aktifkan Notifikasi Live Show';
    }
}

async function toggleNotification() {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('Browser kamu tidak mendukung push notification ðŸ˜¢');
        return;
    }
    const subscribed = await isSubscribed();
    if (subscribed) {
        await unsubscribeNotification();
    } else {
        await subscribeNotification();
    }
}

async function subscribeNotification() {
    try {
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') {
            alert('Izin notifikasi ditolak ðŸ˜¢\nAktifkan di pengaturan browser kamu.');
            return;
        }
        if (!swRegistration) {
            swRegistration = await navigator.serviceWorker.ready;
        }
        const subscription = await swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        // Simpan ke Supabase
        const { error } = await db.from('push_subscriptions').upsert([
            { subscription: subscription.toJSON(), created_at: new Date().toISOString() }
        ]);
        if (error) {
            console.error('Supabase push_subscriptions error:', error);
            // Tetap lanjut meski ada error simpan, subscription tetap aktif di browser
        }
        console.log('âœ… Subscribed to push notifications');
        updateNotifButtonState();
        // Tampilkan notif test
        await swRegistration.showNotification('ðŸ”” Notifikasi Aktif!', {
            body: 'Kamu akan dapat notif saat JKT48 show LIVE ðŸ”¥',
            icon: '/img/logo.png',
            badge: '/img/logo.png',
            tag: 'jkt48-welcome'
        });
    } catch (err) {
        console.error('Subscribe error:', err);
        if (err.message && err.message.includes('applicationServerKey')) {
            alert('âŒ VAPID Public Key belum diisi!\nBuka index.html dan ganti GANTI_DENGAN_PUBLIC_KEY_VAPID_KAMU dengan key kamu.');
        } else {
            alert('Gagal subscribe notifikasi: ' + err.message);
        }
    }
}

async function unsubscribeNotification() {
    try {
        if (!swRegistration) return;
        const subscription = await swRegistration.pushManager.getSubscription();
        if (subscription) {
            // Hapus dari Supabase
            await db.from('push_subscriptions')
                .delete()
                .eq('subscription->>endpoint', subscription.endpoint);
            await subscription.unsubscribe();
            console.log('âœ… Unsubscribed from push notifications');
        }
        updateNotifButtonState();
        alert('ðŸ”• Notifikasi dinonaktifkan.');
    } catch (err) {
        console.error('Unsubscribe error:', err);
    }
}

// ============= INITIALIZATION =============
document.addEventListener('DOMContentLoaded', () => {
    initServiceWorker();
    loadData();
    if (liveShowRefreshInterval) clearInterval(liveShowRefreshInterval);
    liveShowRefreshInterval = setInterval(() => {
        updateLiveShowBanner();
    }, 30000);
});

window.addEventListener('unload', () => {
    if (liveShowRefreshInterval) clearInterval(liveShowRefreshInterval);
});
</script>
</body>
</html>